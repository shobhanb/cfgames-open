<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/me"></ion-back-button>
    </ion-buttons>
    <ion-title>My Heats</ion-title>
    <app-toolbar-buttons slot="end"></app-toolbar-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Select Event</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-select
          label="Event"
          labelPlacement="stacked"
          placeholder="Select event"
          interface="popover"
          [(ngModel)]="selectedOrdinal"
          (ionChange)="onEventSelect()"
        >
          @for (event of eventService.currentYearWeekendAllEvents(); track
          event.ordinal) {
          <ion-select-option [value]="event.ordinal">
            {{ event.event }}
          </ion-select-option>
          }
        </ion-select>
      </ion-item>
    </ion-card-content>
  </ion-card>

  @if (selectedEventName() && dataLoaded()) {
  <!-- Athlete Heat Assignment -->
  @if (athleteAssignment()) {
  <div class="heat-group">
    <div class="group-header">
      <h2 class="group-title">My Heat</h2>
    </div>
    <ion-grid class="heats-grid">
      <ion-row>
        <ion-col size="12" sizeMd="6" sizeLg="4" sizeXl="3">
          <ion-card class="heat-card">
            <ion-card-header>
              <ion-card-title>
                {{ getHeatDetails(athleteAssignment()!.heat_id)?.start_time |
                date: 'EEE d MMM, h:mm a' }}
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="section">
                <div class="section-header">
                  <h3>
                    <ion-icon name="person"></ion-icon>
                    Your Heat
                  </h3>
                </div>
                <table class="assignments-table">
                  <thead>
                    <tr>
                      <th>Athlete</th>
                      <th>Judge</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        {{ athleteAssignment()!.athlete_name || '—' }} @if
                        (athleteAssignment()!.athlete_crossfit_id &&
                        athleteDataService.getAgeCategory(athleteAssignment()!.athlete_crossfit_id!)
                        === 'U18') {
                        <span class="age-indicator">U18</span>
                        } @else if (athleteAssignment()!.athlete_crossfit_id &&
                        athleteDataService.getAgeCategory(athleteAssignment()!.athlete_crossfit_id!)
                        === 'Masters 55+') {
                        <span class="age-indicator">55+</span>
                        }
                      </td>
                      <td>{{ athleteAssignment()!.judge_name || '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
  } @else {
  <ion-card>
    <ion-card-content>
      <p class="ion-text-center">No athlete assignment for this event.</p>
    </ion-card-content>
  </ion-card>
  }

  <!-- Judge Assignments (only for judges) -->
  @if (isJudge && judgeAssignments().length > 0) {
  <div class="heat-group">
    <div class="group-header">
      <h2 class="group-title">My Judging Assignments</h2>
    </div>
    <ion-card>
      <ion-card-content>
        <table class="assignments-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Judging</th>
            </tr>
          </thead>
          <tbody>
            @for (assignment of judgeAssignments(); track $index) {
            <tr>
              <td>
                {{ getHeatDetails(assignment.heat_id)?.start_time | date: 'EEE d
                MMM, h:mm a' }}
              </td>
              <td>
                {{ assignment.athlete_name || '—' }} @if
                (assignment.athlete_crossfit_id) { @if
                (athleteDataService.getAgeCategory(assignment.athlete_crossfit_id)
                === 'U18') {
                <span class="age-indicator">U18</span>
                } @else if
                (athleteDataService.getAgeCategory(assignment.athlete_crossfit_id)
                === 'Masters 55+') {
                <span class="age-indicator">55+</span>
                } }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </ion-card-content>
    </ion-card>
  </div>
  } } @else if (selectedEventName() && !dataLoaded()) {
  <!-- Loading state -->
  <div class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading your heats...</p>
  </div>
  }
</ion-content>
