<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Appreciation Scores</ion-title>
    <app-toolbar-buttons slot="end"></app-toolbar-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  @if (dataLoaded()) {
  <!-- Existing Appreciation Scores -->
  @if (appreciationScores().length > 0) {
  <ion-card>
    <ion-card-header>
      <ion-card-title>Existing Appreciation Scores</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        @for (appreciationScore of appreciationScores(); track
        appreciationScore.ordinal + '-' + appreciationScore.crossfit_id) {
        <ion-item>
          <ion-label>
            <h2>{{ getEventName(appreciationScore.ordinal) }}</h2>
            <p>{{ getAthleteName(appreciationScore.crossfit_id) }}</p>
            <p>Score: {{ appreciationScore.score }}</p>
          </ion-label>
          <ion-button
            slot="end"
            fill="outline"
            size="small"
            (click)="loadScore(appreciationScore)"
          >
            Edit
          </ion-button>
          <ion-button
            slot="end"
            fill="outline"
            size="small"
            color="danger"
            (click)="confirmDelete(appreciationScore)"
          >
            Delete
          </ion-button>
        </ion-item>
        }
      </ion-list>
    </ion-card-content>
  </ion-card>
  }

  <!-- Add/Update Form -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Add/Update Appreciation Score</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <!-- Event Selection -->
        <ion-item>
          <ion-select
            label="Event"
            labelPlacement="stacked"
            placeholder="Select event"
            interface="popover"
            [(ngModel)]="selectedOrdinal"
          >
            @for (event of currentYearEvents(); track event.ordinal) {
            <ion-select-option [value]="event.ordinal">
              {{ event.event }}
            </ion-select-option>
            }
          </ion-select>
        </ion-item>

        <!-- Athlete Selection -->
        <ion-item>
          <ion-select
            label="Athlete"
            labelPlacement="stacked"
            placeholder="Select athlete"
            interface="popover"
            [(ngModel)]="selectedCrossfitId"
          >
            @for (athlete of athletes(); track athlete.crossfit_id) {
            <ion-select-option [value]="athlete.crossfit_id">
              {{ athlete.name }} ({{ athlete.team_name }})
            </ion-select-option>
            }
          </ion-select>
        </ion-item>

        <!-- Score -->
        <ion-item>
          <ion-input
            label="Score"
            labelPlacement="stacked"
            type="number"
            placeholder="Enter score"
            [(ngModel)]="score"
          ></ion-input>
        </ion-item>
      </ion-list>

      <div class="button-container">
        <ion-button expand="block" (click)="save()">Save</ion-button>
        <ion-button expand="block" fill="outline" (click)="resetForm()"
          >Clear</ion-button
        >
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Apply Scores -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Apply Appreciation Scores</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>
        Apply all saved appreciation scores to teams. This will update team
        totals.
      </p>
      <ion-button expand="block" color="primary" (click)="apply()">
        Apply Scores to Teams
      </ion-button>
    </ion-card-content>
  </ion-card>
  } @else {
  <!-- Loading State -->
  <ion-card>
    <ion-card-header>
      <ion-skeleton-text
        [animated]="true"
        style="width: 50%"
      ></ion-skeleton-text>
    </ion-card-header>
    <ion-card-content>
      <ion-skeleton-text
        [animated]="true"
        style="width: 80%"
      ></ion-skeleton-text>
      <ion-skeleton-text
        [animated]="true"
        style="width: 60%"
      ></ion-skeleton-text>
      <ion-skeleton-text
        [animated]="true"
        style="width: 90%"
      ></ion-skeleton-text>
    </ion-card-content>
  </ion-card>
  }

  <ion-alert
    [isOpen]="deleteAlertOpen()"
    header="Confirm Delete"
    message="Are you sure you want to delete this appreciation score?"
    [buttons]="deleteAlertButtons"
  ></ion-alert>
</ion-content>
