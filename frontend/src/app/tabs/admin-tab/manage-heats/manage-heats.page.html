<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>Manage Heats</ion-title>
    <app-toolbar-buttons slot="end"></app-toolbar-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Event Selection -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Select Event</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item>
        <ion-select
          label="Event"
          labelPlacement="stacked"
          placeholder="Select event"
          interface="popover"
          [ngModel]="selectedOrdinal()"
          (ngModelChange)="selectedOrdinal.set($event); onEventSelect()"
        >
          @for (event of currentYearEvents(); track event.ordinal) {
          <ion-select-option [value]="event.ordinal">
            {{ event.event }}
          </ion-select-option>
          }
        </ion-select>
      </ion-item>
      @if (selectedOrdinal()) {
      <ion-button
        expand="block"
        color="primary"
        [disabled]="loading()"
        (click)="assignRandom()"
      >
        <ion-icon slot="start" name="shuffle"></ion-icon>
        Assign Athletes & Judges
      </ion-button>
      <ion-button
        expand="block"
        color="danger"
        fill="outline"
        [disabled]="loading()"
        (click)="deleteAllAssignments()"
      >
        <ion-icon slot="start" name="trash"></ion-icon>
        Delete All Assignments
      </ion-button>
      }
    </ion-card-content>
  </ion-card>

  @if (selectedOrdinal() && dataLoaded() && heats().length > 0) {
  <!-- Search Bar -->
  <ion-card>
    <ion-card-content style="padding: 12px">
      <ion-searchbar
        [(ngModel)]="searchTerm"
        (ionInput)="onSearchChange($event)"
        placeholder="Search by athlete or judge name"
        debounce="300"
        animated="true"
      ></ion-searchbar>
      <ion-button
        expand="block"
        fill="outline"
        (click)="showUnassignedAthletes()"
        style="margin-top: 8px"
      >
        <ion-icon slot="start" name="person"></ion-icon>
        Show Unassigned Athletes ({{ unassignedAthletes().length }})
      </ion-button>
    </ion-card-content>
  </ion-card>
  } @if (loading()) {
  <!-- Loading State -->
  <div class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading heats...</p>
  </div>
  } @else if (dataLoaded() && heats().length === 0 && selectedOrdinal()) {
  <!-- No Heats -->
  <ion-card>
    <ion-card-content>
      <p class="ion-text-center">No heats found for this event.</p>
    </ion-card-content>
  </ion-card>
  } @else if (dataLoaded() && heats().length > 0) {
  <!-- Heats Grid -->
  @for (group of groupedHeats(); track group.shortName) {
  <div class="heat-group">
    <div class="group-header">
      <h2 class="group-title">{{ group.shortName }}</h2>
      <div class="group-actions">
        <ion-button
          size="small"
          [fill]="getAssignmentsForHeat(group.heats[0])[0]?.is_locked ? 'solid' : 'outline'"
          [color]="getAssignmentsForHeat(group.heats[0])[0]?.is_locked ? 'danger' : ''"
          (click)="toggleLockedForGroup(group.shortName)"
          [disabled]="getAssignmentsForHeat(group.heats[0]).length === 0"
        >
          <ion-icon
            slot="icon-only"
            [name]="getAssignmentsForHeat(group.heats[0])[0]?.is_locked ? 'lock-closed-outline' : 'lock-open-outline'"
          ></ion-icon>
        </ion-button>
        <ion-button
          size="small"
          [fill]="getAssignmentsForHeat(group.heats[0])[0]?.is_published ? 'solid' : 'outline'"
          [color]="getAssignmentsForHeat(group.heats[0])[0]?.is_published ? 'danger' : ''"
          (click)="togglePublishedForGroup(group.shortName)"
          [disabled]="getAssignmentsForHeat(group.heats[0]).length === 0"
        >
          <ion-icon
            slot="icon-only"
            [name]="getAssignmentsForHeat(group.heats[0])[0]?.is_published ? 'cloud-done-outline' : 'cloud-offline-outline'"
          ></ion-icon>
        </ion-button>
        <ion-button
          size="small"
          fill="outline"
          (click)="showJudgeSummary(group.shortName)"
        >
          <ion-icon slot="start" name="stats-chart-outline"></ion-icon>
          Judge Summary
        </ion-button>
      </div>
    </div>
    <ion-grid class="heats-grid">
      <ion-row>
        @for (heat of group.heats; track $index) {
        <ion-col size="12" sizeMd="6" sizeLg="4" sizeXl="3">
          <ion-card class="heat-card">
            <ion-card-header>
              <ion-card-title>
                {{ heat.start_time | date: 'EEE d MMM, h:mm a' }}
              </ion-card-title>
              <div class="heat-checkboxes">
                <ion-button
                  size="small"
                  [fill]="getAssignmentsForHeat(heat)[0]?.is_locked ? 'solid' : 'clear'"
                  [color]="getAssignmentsForHeat(heat)[0]?.is_locked ? 'danger' : ''"
                  (click)="toggleLocked(heat)"
                  [disabled]="getAssignmentsForHeat(heat).length === 0"
                >
                  <ion-icon
                    slot="icon-only"
                    [name]="getAssignmentsForHeat(heat)[0]?.is_locked ? 'lock-closed-outline' : 'lock-open-outline'"
                  ></ion-icon>
                </ion-button>
                <ion-button
                  size="small"
                  [fill]="getAssignmentsForHeat(heat)[0]?.is_published ? 'solid' : 'clear'"
                  [color]="getAssignmentsForHeat(heat)[0]?.is_published ? 'danger' : ''"
                  (click)="togglePublished(heat)"
                  [disabled]="getAssignmentsForHeat(heat).length === 0"
                >
                  <ion-icon
                    slot="icon-only"
                    [name]="getAssignmentsForHeat(heat)[0]?.is_published ? 'cloud-done-outline' : 'cloud-offline-outline'"
                  ></ion-icon>
                </ion-button>
              </div>
            </ion-card-header>
            <ion-card-content>
              <!-- Athletes Section -->
              <div class="section">
                <div class="section-header">
                  <h3>
                    <ion-icon name="person"></ion-icon>
                    {{ 'Athletes (' + getAssignmentsForHeat(heat).length + '/' +
                    heat.max_athletes + ')'}}
                  </h3>
                  <ion-button
                    size="small"
                    fill="clear"
                    (click)="addAthlete(heat)"
                    [disabled]="!isHeatEditable(heat)"
                  >
                    <ion-icon slot="icon-only" name="add"></ion-icon>
                  </ion-button>
                </div>

                <table class="assignments-table">
                  <thead>
                    <tr>
                      <th>Athlete</th>
                      <th>Judge</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (assignment of getAssignmentsForHeat(heat); track
                    assignment.id) {
                    <tr>
                      <td
                        (click)="updateAthlete(assignment, heat)"
                        (contextmenu)="setHoveredJudge(assignment.athlete_name); $event.preventDefault()"
                        class="clickable"
                        [id]="'athlete-' + assignment.id"
                        [class.missing-athlete]="!assignment.athlete_name"
                        [class.conflict-cell]="
                          (assignment.athlete_crossfit_id &&
                          getConflictingCrossfitIds(heat).has(
                            assignment.athlete_crossfit_id
                          )) ||
                          (assignment.athlete_crossfit_id &&
                          duplicateAthleteIds().has(assignment.athlete_crossfit_id))
                        "
                        [class.highlighted-judge]="
                          hoveredJudgeName() &&
                          assignment.athlete_name &&
                          assignment.athlete_name === hoveredJudgeName()
                        "
                        [class.disabled]="!isHeatEditable(heat)"
                      >
                        {{ assignment.athlete_name ? (assignment.preference_nbr
                        ? assignment.athlete_name + ' (' +
                        assignment.preference_nbr + ')' :
                        assignment.athlete_name) : 'Assign Athlete' }}
                        <ion-popover
                          [trigger]="'athlete-' + assignment.id"
                          triggerAction="context-menu"
                          size="auto"
                        >
                          <ng-template>
                            <ion-content class="prefs-popover">
                              @if
                              (getAthletePreferences(assignment.athlete_crossfit_id))
                              {
                              <ion-list>
                                <ion-item lines="none">
                                  <ion-label class="ion-text-wrap">
                                    {{
                                    getAthletePreferences(assignment.athlete_crossfit_id)
                                    }}
                                  </ion-label>
                                </ion-item>
                              </ion-list>
                              }
                            </ion-content>
                          </ng-template>
                        </ion-popover>
                      </td>
                      <td
                        (click)="updateJudge(assignment, heat)"
                        (contextmenu)="setHoveredJudge(assignment.judge_name); $event.preventDefault()"
                        class="clickable"
                        [class.missing-judge]="!assignment.judge_name"
                        [class.highlighted-judge]="
                          hoveredJudgeName() &&
                          assignment.judge_name &&
                          assignment.judge_name === hoveredJudgeName()
                        "
                        [class.conflict-cell]="
                          assignment.judge_crossfit_id &&
                          getConflictingCrossfitIds(heat).has(
                            assignment.judge_crossfit_id
                          )
                        "
                        [class.disabled]="!isHeatEditable(heat)"
                      >
                        {{ assignment.judge_name || 'Assign Judge' }}
                      </td>
                      <td class="action-cell">
                        <ion-button
                          size="small"
                          fill="clear"
                          color="danger"
                          (click)="removeAssignment(assignment)"
                          [disabled]="!isHeatEditable(heat)"
                        >
                          <ion-icon slot="icon-only" name="close"></ion-icon>
                        </ion-button>
                      </td>
                    </tr>
                    } @empty {
                    <tr>
                      <td colspan="3" class="empty-message">
                        No athletes assigned
                      </td>
                    </tr>
                    }
                  </tbody>
                </table>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
        }
      </ion-row>
    </ion-grid>
  </div>
  } }
</ion-content>
